export const generatePersonalizedAdvice = async (profile) => {
    const { weightKg, goalWeightKg, gender, activityLevel, name } = profile;

    if (!weightKg || !goalWeightKg) {
        return null; // –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏
    }

    const weightDiff = weightKg - goalWeightKg;
    const needToLose = weightDiff > 0;
    const weightChange = Math.abs(weightDiff);

    const adviceTopics = [
        {
            topic: '–∫–ª–µ—Ç—á–∞—Ç–∫–∞',
            prompt: `–î–∞–π –∫—Ä–∞—Ç–∫–∏–π –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–π —Å–æ–≤–µ—Ç (60-100 —Å–ª–æ–≤) –æ –∫–ª–µ—Ç—á–∞—Ç–∫–µ –¥–ª—è —á–µ–ª–æ–≤–µ–∫–∞ –≤–µ—Å–æ–º ${weightKg}–∫–≥ —Å —Ü–µ–ª—å—é –¥–æ—Å—Ç–∏—á—å ${goalWeightKg}–∫–≥. ${needToLose ? '–ù—É–∂–Ω–æ —Å–Ω–∏–∑–∏—Ç—å –≤–µ—Å' : '–ù—É–∂–Ω–æ –Ω–∞–±—Ä–∞—Ç—å –≤–µ—Å'} –Ω–∞ ${weightChange}–∫–≥. –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º - –Ω–∞–∑–æ–≤–∏ –ø—Ä–æ–¥—É–∫—Ç—ã –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ.`
        },
        {
            topic: '–≤–æ–¥–∞',
            prompt: `–î–∞–π –∫—Ä–∞—Ç–∫–∏–π —Å–æ–≤–µ—Ç (60-100 —Å–ª–æ–≤) –æ –≤–æ–¥–Ω–æ–º –±–∞–ª–∞–Ω—Å–µ –¥–ª—è —á–µ–ª–æ–≤–µ–∫–∞ ${needToLose ? '—Å–Ω–∏–∂–∞—é—â–µ–≥–æ' : '–Ω–∞–±–∏—Ä–∞—é—â–µ–≥–æ'} –≤–µ—Å. –¢–µ–∫—É—â–∏–π –≤–µ—Å ${weightKg}–∫–≥. –†–∞—Å—Å—á–∏—Ç–∞–π –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–¥—ã –∏ –¥–∞–π –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–µ —Å–æ–≤–µ—Ç—ã.`
        },
        {
            topic: '–±–µ–ª–æ–∫',
            prompt: `–î–∞–π –∫—Ä–∞—Ç–∫–∏–π —Å–æ–≤–µ—Ç (60-100 —Å–ª–æ–≤) –æ –±–µ–ª–∫–µ –≤ —Ä–∞—Ü–∏–æ–Ω–µ –¥–ª—è ${gender === 'male' ? '–º—É–∂—á–∏–Ω—ã' : '–∂–µ–Ω—â–∏–Ω—ã'} —Å —É—Ä–æ–≤–Ω–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ "${activityLevel || '—É–º–µ—Ä–µ–Ω–Ω–∞—è'}". –¶–µ–ª—å: ${needToLose ? '–ø–æ—Ö—É–¥–µ—Ç—å' : '–Ω–∞–±—Ä–∞—Ç—å –º–∞—Å—Å—É'}. –ù–∞–∑–æ–≤–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –±–µ–ª–∫–∞ –∏ –Ω–æ—Ä–º—É.`
        },
        {
            topic: '–∂–∏—Ä—ã',
            prompt: `–î–∞–π –∫—Ä–∞—Ç–∫–∏–π —Å–æ–≤–µ—Ç (60-100 —Å–ª–æ–≤) –æ –∑–¥–æ—Ä–æ–≤—ã—Ö –∂–∏—Ä–∞—Ö –¥–ª—è —á–µ–ª–æ–≤–µ–∫–∞ —Å —Ü–µ–ª—å—é ${needToLose ? '–ø–æ—Ö—É–¥–µ—Ç—å' : '–Ω–∞–±—Ä–∞—Ç—å –≤–µ—Å'} –Ω–∞ ${weightChange}–∫–≥. –ö–∞–∫–∏–µ –∂–∏—Ä—ã –ø–æ–º–æ–≥—É—Ç, –∞ –∫–∞–∫–∏—Ö –∏–∑–±–µ–≥–∞—Ç—å? –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º.`
        },
        {
            topic: '–∫–∞–ª–æ—Ä–∏–∏',
            prompt: `–î–∞–π –∫—Ä–∞—Ç–∫–∏–π —Å–æ–≤–µ—Ç (60-100 —Å–ª–æ–≤) –æ –∫–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç–∏ —Ä–∞—Ü–∏–æ–Ω–∞ –¥–ª—è —á–µ–ª–æ–≤–µ–∫–∞ ${weightKg}–∫–≥, —Ü–µ–ª—å ${goalWeightKg}–∫–≥. ${needToLose ? '–î–µ—Ñ–∏—Ü–∏—Ç –∫–∞–ª–æ—Ä–∏–π' : '–ü—Ä–æ—Ñ–∏—Ü–∏—Ç –∫–∞–ª–æ—Ä–∏–π'} - –∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å—á–∏—Ç–∞—Ç—å? –î–∞–π –ø—Ä–∞–∫—Ç–∏—á–Ω—É—é —Ñ–æ—Ä–º—É–ª—É.`
        },
        {
            topic: '–¥—Ä–æ–±–Ω–æ–µ –ø–∏—Ç–∞–Ω–∏–µ',
            prompt: `–î–∞–π –∫—Ä–∞—Ç–∫–∏–π —Å–æ–≤–µ—Ç (60-100 —Å–ª–æ–≤) –æ —Ä–µ–∂–∏–º–µ –ø–∏—Ç–∞–Ω–∏—è –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–∏ ${needToLose ? '–ø–æ—Ö—É–¥–µ—Ç—å' : '–Ω–∞–±—Ä–∞—Ç—å –≤–µ—Å'}. –¢–µ–∫—É—â–∏–π –≤–µ—Å ${weightKg}–∫–≥. –°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤ –¥–µ–Ω—å –µ—Å—Ç—å –∏ –ø–æ—á–µ–º—É?`
        }
    ];

    const randomTopic = adviceTopics[Math.floor(Math.random() * adviceTopics.length)];

    try {
        const response = await fetch(`${process.env.GEMINI_API_BASE_URL}/v1beta/models/${process.env.GEMINI_MODEL}:generateContent?key=${process.env.GEMINI_API_KEY}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{
                    parts: [{
                        text: `–¢—ã –æ–ø—ã—Ç–Ω—ã–π –Ω—É—Ç—Ä–∏—Ü–∏–æ–ª–æ–≥ –∏ —Ñ–∏—Ç–Ω–µ—Å-—Ç—Ä–µ–Ω–µ—Ä. ${randomTopic.prompt}\n\n–ù–∞—á–Ω–∏ —Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è${name ? ` "${name}"` : ''}, –∑–∞—Ç–µ–º –¥–∞–π —Å–æ–≤–µ—Ç. –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º, –º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–º –∏ –∑–∞–±–æ—Ç–ª–∏–≤—ã–º.`
                    }]
                }]
            })
        });

        const data = await response.json();
        const advice = data.candidates?.[0]?.content?.parts?.[0]?.text;

        return advice ? `üí° **–°–æ–≤–µ—Ç –¥–Ω—è: ${randomTopic.topic}**\n\n${advice}` : null;
    } catch (error) {
        console.error('Failed to generate personalized advice:', error);
        return null;
    }
};
